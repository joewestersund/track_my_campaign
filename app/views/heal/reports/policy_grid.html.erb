<h1>Policy Grid Report</h1>

<div class="filter">
  <%= form_tag request.path, method: 'get' do %>
    <div class="field">
      <%= label_tag :state %>
      <%= text_field_tag :state, params[:state] %>
    </div>
    <div class="field">
      <%= label_tag :county %>
      <%= text_field_tag :county, params[:county] %>
    </div>
    <div class="field">
      <%= label_tag :name %>
      <%= text_field_tag :name, params[:name] %>
    </div>
    <div class="field">
      <%= label_tag :min_population %>
      <%= number_field_tag :min_population, params[:min_population] %>
    </div>
    <div class="field">
      <%= label_tag :max_population %>
      <%= number_field_tag :max_population, params[:max_population] %>
    </div>
    <div class="field">
      <%= label_tag :min_percent_obesity %>
      <%= number_field_tag :min_percent_obesity, params[:min_percent_obesity] %>
    </div>
    <div class="field">
      <%= label_tag :max_percent_obesity %>
      <%= number_field_tag :max_percent_obesity, params[:max_percent_obesity] %>
    </div>
    <div class="field">
      <%= label_tag "Current City Designation" %>
      <%= select_tag :city_designation_id, options_from_collection_for_select(@city_designations,:id,:name,params[:city_designation_id]), { :include_blank => true } %>
    </div>
    <div class="field">
      <%= label_tag :policy_change_in_progress %>
      <%= select_tag :policy_change_in_progress, options_for_select(get_yes_no_options_list,params[:policy_change_in_progress]), { :include_blank => true } %>
    </div>
    <div class="actions">
      <%= submit_tag "Search" %>
    </div>
  <% end %>
</div>

<%= link_to 'New Heal City Designation Achievement', new_heal_city_designation_achievement_path %> |
<%= link_to 'New Policy Adoption', new_heal_policy_adoption_path %> |
<%= link_to 'New Resolution', new_heal_resolution_path %>
<br><br>

<% policy_ids = [] %>
<% if @cities.nil? or @cities.count == 0 %>
  <div class="no_data">No data has been entered, or no data matches the filter above.</div>
<% else %>
  <table>
    <thead>
    <tr>
      <th>State</th>
      <th>County</th>
      <th>Name</th>
      <th>Population</th>
      <th>% Obesity</th>
      <th>Median Income</th>
      <th>HEAL City Designation</th>
      <th>Policy Change in Progress</th>
      <% @policies.each do |policy| %>
        <% policy_ids << policy.id %>
        <th class="angle-text"><%= policy.name %></th>
      <% end %>
    </tr>
    </thead>

    <tbody>
    <% @cities.each do |city| %>
      <tr>
        <td><%= city.state %></td>
        <td><%= city.county %></td>
        <td><%= link_to city.name, edit_heal_city_path(city)%></td>
        <td><%= city.population %></td>
        <td><%= show_percentage(city.percent_obesity) %></td>
        <td><%= number_to_currency(city.city_median_income, precision: 0) %></td>
        <td class="bold-black <%= get_city_designation_class(city) %>"><%= show_city_designation_achievements_list(city) %>
        <td><%= show_boolean(city.policy_change_in_progress) %></td>
        <% @policies.each do |policy| %>
          <% pa = city.policy_adoptions.joins(:policies).where("policies_policy_adoptions.policy_id" => policy.id).order(date: :desc).first
           if pa.present?
              if pa.prior_to_joining_campaign
                %><td class="bold-white prior"><%= link_to "P", heal_policy_adoption_path(pa), title: pa.notes %></td><%
              else
                %><td class="bold-white adopted-in-<%=pa.date.year%>"><%= link_to pa.date.year, heal_policy_adoption_path(pa), title: pa.notes %></td><%
              end
            else
                res = city.resolutions.joins(:policies).where("policies_resolutions.policy_id" => policy.id).order(date: :desc).first
                if res.present?
                  %> <td class="bold-white resolution"><%= link_to "R", heal_resolution_path(res), title: res.notes %></td><%
                else
                  %> <td></td><%
                end
            end %>
            </td>
        <% end %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
  <%= will_paginate @cities %>
<% end %>